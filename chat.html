<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        header {
            background-color: #1e1e1e;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            position: relative; /* For dropdown positioning */
            z-index: 1000;
        }
        header .back-icon {
            font-size: 24px;
            cursor: pointer;
            color: #bb86fc;
            margin-right: 15px;
        }
        header .chat-header-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        header .user-avatar {
            width: 40px;
            height: 40px;
            background-color: #bb86fc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #121212;
            margin-right: 10px;
            overflow: hidden; /* For profile pictures */
        }
        header .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        header .username-container {
            display: flex;
            flex-direction: row; /* Keep username and verification icon in a row */
            align-items: center;
        }
        header .username {
            font-size: 18px;
            font-weight: bold;
        }
        header .options-icon {
            font-size: 24px;
            cursor: pointer;
            color: #bb86fc;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 55px; /* Adjust to be below the header */
            right: 15px;
            background-color: #2c2c2c;
            min-width: 150px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
            z-index: 1001;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-menu a {
            color: #e0e0e0;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-menu a:hover {
            background-color: #3a3a3a;
        }

        /* Chat Messages Container */
        #chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Message Styling */
        .message {
            display: flex;
            margin-bottom: 10px;
            /* Added margin-right to prevent messages from touching the edge */
            margin-right: 15px; 
        }
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        .message-content {
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .message-footer {
            display: flex;
            align-items: center;
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }
        .message-footer .tick-icon {
            margin-left: 5px;
        }
        .message-footer .tick-icon.seen {
            color: #bb86fc;
        }

        .sent {
            justify-content: flex-end;
            margin-left: auto; /* Push sent messages to the right */
        }
        .sent .message-content-wrapper {
            align-items: flex-end;
        }
        .sent .message-content {
            background-color: #bb86fc;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .received {
            justify-content: flex-start;
        }
        .received .message-content-wrapper {
            align-items: flex-start;
        }
        .received .message-content {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        /* Typing Indicator Bubble */
        .typing-indicator-bubble {
            display: flex; /* Always display as flex to manage visibility with a class */
            justify-content: flex-start;
            margin-bottom: 10px;
            max-width: 70%; /* Limit width like other received messages */
            /* Add an opacity transition for a smooth show/hide effect */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Prevent it from interfering with clicks */
        }

        .typing-indicator-bubble.show {
            opacity: 1;
        }

        .typing-indicator-bubble .message-content-wrapper {
            background-color: #2c2c2c;
            padding: 10px 15px;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: fit-content; /* Allow content to dictate width */
        }
        .typing-indicator-bubble .dots {
            display: flex;
            align-items: center;
        }
        .typing-indicator-bubble .dot {
            width: 8px;
            height: 8px;
            background-color: #bb86fc;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .typing-indicator-bubble .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator-bubble .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
        }

        /* Message Input Area */
        #message-input-container {
            background-color: #1e1e1e;
            padding: 10px 15px;
            display: flex;
            align-items: flex-end; /* Align items to the bottom */
            border-top: 1px solid #2c2c2c;
        }
        #messageInput {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 100px; /* Limit max height to prevent overflow */
            box-sizing: border-box;
            overflow-y: auto;
        }
        #sendBtn {
            background-color: #bb86fc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent the button from shrinking */
        }
        #sendBtn:hover {
            background-color: #9a67ea;
        }

        /* Verified Tick SVG styling */
        .verified-tick {
            width: 16px;
            height: 16px;
            margin-left: 5px;
            margin-bottom: -2px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header>
        <div class="back-icon" id="backIcon"><i class="fas fa-arrow-left"></i></div>
        <div class="chat-header-info">
            <div id="userAvatar" class="user-avatar"></div>
            <div class="username-container">
                <span class="username" id="chatUsername"></span>
            </div>
        </div>
        <div class="options-icon" id="optionsIcon"><i class="fas fa-ellipsis-v"></i></div>
        <div id="dropdownMenu" class="dropdown-menu">
            <a href="#" id="clearChatBtn">Clear Chat</a>
        </div>
    </header>

    <main id="chat-messages">
        </main>

    <div id="message-input-container">
        <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
        <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAdu3d0_qEDZaXkBkJAO0VY0htme6_EMyM",
          authDomain: "bluegram-27a79.firebaseapp.com",
          databaseURL: "https://bluegram-27a79-default-rtdb.firebaseio.com",
          projectId: "bluegram-27a79",
          storageBucket: "bluegram-27a79.firebasestorage.app",
          messagingSenderId: "780485443121",
          appId: "1:780485443121:web:f7469d2264293fcbdf5f10",
          measurementId: "G-YF5S9HK2Q5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Get UI elements
        const chatUsernameElement = document.getElementById('chatUsername');
        const usernameContainer = document.querySelector('.username-container');
        const userAvatarElement = document.getElementById('userAvatar');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const backIcon = document.getElementById('backIcon');
        const optionsIcon = document.getElementById('optionsIcon');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const clearChatBtn = document.getElementById('clearChatBtn');

        // Create the typing indicator element once
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typingIndicator';
        typingIndicator.className = 'typing-indicator-bubble';
        typingIndicator.innerHTML = `
            <div class="message-content-wrapper">
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        `;

        let currentUser = null;
        let targetUserId = null;
        let chatRef = null;
        let chatKey = null;
        let typingTimeout = null;

        const verifiedSVG = `
            <svg class="verified-tick" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">
                <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                    <path d="M 30.091 10.131 L 30.091 10.131 c 5.28 -13.046 23.695 -13.207 29.202 -0.255 l 0 0 l 0 0 c 12.959 -5.491 26.093 7.416 20.829 20.469 l 0 0 l 0 0 c 13.046 5.28 13.207 23.695 0.255 29.202 l 0 0 l 0 0 c 5.491 12.959 -7.416 26.093 -20.469 20.829 l 0 0 l 0 0 c -5.28 13.046 -23.695 13.207 -29.202 0.255 l 0 0 l 0 0 C 17.748 86.122 4.613 73.215 9.878 60.162 l 0 0 l 0 0 C -3.169 54.881 -3.33 36.467 9.623 30.96 l 0 0 l 0 0 C 4.131 18.001 17.038 4.866 30.091 10.131 L 30.091 10.131 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,150,241); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>
                    <polygon points="39.66,63.79 23.36,47.76 28.97,42.05 39.3,52.21 59.6,29.58 65.56,34.93 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
                </g>
            </svg>
        `;

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                targetUserId = urlParams.get('uid');

                if (targetUserId) {
                    setupChat();
                } else {
                    alert('Invalid user selected.');
                    window.location.href = 'home.html';
                }
            }
        });

        optionsIcon.addEventListener('click', (e) => {
            dropdownMenu.classList.toggle('show');
            e.stopPropagation();
        });

        window.addEventListener('click', (e) => {
            if (!dropdownMenu.contains(e.target) && !optionsIcon.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        clearChatBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear this chat history? This action cannot be undone.")) {
                clearChat();
            }
            dropdownMenu.classList.remove('show');
        });

        function clearChat() {
            chatRef.child('messages').remove()
            .then(() => {
                const emptyLastMessageData = {
                    lastMessage: 'Chat cleared',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref(`user-chats/${currentUser.uid}/${targetUserId}`).update(emptyLastMessageData);
                database.ref(`user-chats/${targetUserId}/${currentUser.uid}`).update(emptyLastMessageData);

                console.log("Chat history cleared successfully.");
                alert("Chat history cleared.");

                location.reload();
            })
            .catch(error => {
                console.error("Error clearing chat:", error);
                alert("Error clearing chat: " + error.message);
            });
        }

        function setupChat() {
            chatKey = [currentUser.uid, targetUserId].sort().join('_');
            chatRef = database.ref(`chats/${chatKey}`);

            database.ref(`user-chats/${currentUser.uid}/${targetUserId}/unreadCount`).set(0);

            const userProfileRef = database.ref(`users/${targetUserId}`);
            userProfileRef.on('value', snapshot => {
                if (snapshot.exists()) {
                    const userProfile = snapshot.val();
                    const username = userProfile.username;
                    const isVerified = userProfile.verified === true;
                    const profilePictureUrl = userProfile.profile_picture_url;

                    chatUsernameElement.textContent = username;

                    userAvatarElement.innerHTML = '';
                    if (profilePictureUrl) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = profilePictureUrl;
                        avatarImg.alt = username.charAt(0).toUpperCase();
                        userAvatarElement.appendChild(avatarImg);
                    } else {
                        userAvatarElement.textContent = username.charAt(0).toUpperCase();
                    }

                    if (isVerified) {
                        if (!usernameContainer.querySelector('.verified-tick')) {
                            usernameContainer.insertAdjacentHTML('beforeend', verifiedSVG);
                        }
                    } else {
                        const existingTick = usernameContainer.querySelector('.verified-tick');
                        if (existingTick) {
                            existingTick.remove();
                        }
                    }
                } else {
                    chatUsernameElement.textContent = 'Unknown User';
                    userAvatarElement.textContent = '?';
                }
            });

            const typingStatusRef = database.ref(`typing-status/${targetUserId}/${currentUser.uid}`);
            typingStatusRef.on('value', snapshot => {
                const isTyping = snapshot.val() || false;
                if (isTyping) {
                    if (!chatMessages.contains(typingIndicator)) {
                        chatMessages.appendChild(typingIndicator);
                        // Add 'show' class to trigger the transition
                        setTimeout(() => typingIndicator.classList.add('show'), 10);
                    }
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    typingIndicator.classList.remove('show');
                    // Remove the element after the transition
                    setTimeout(() => {
                        if (chatMessages.contains(typingIndicator)) {
                            chatMessages.removeChild(typingIndicator);
                        }
                    }, 300);
                }
            });

            chatRef.child('messages').on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(snapshot.key, message);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                if (message.senderId !== currentUser.uid) {
                    database.ref(`chats/${chatKey}/messages/${snapshot.key}/seen`).set(true);
                }
            });

            chatRef.child('messages').on('child_changed', (snapshot) => {
                const message = snapshot.val();
                if (message.senderId === currentUser.uid && message.seen) {
                    updateMessageSeenStatus(snapshot.key);
                }
            });
        }

        function displayMessage(messageKey, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            messageDiv.dataset.messageKey = messageKey;

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message.text;
            contentWrapper.appendChild(contentDiv);

            const footerDiv = document.createElement('div');
            footerDiv.className = 'message-footer';

            const timestamp = new Date(message.timestamp);
            footerDiv.textContent = formatTimestamp(timestamp);

            if (message.senderId === currentUser.uid) {
                const tickIcon = document.createElement('i');
                tickIcon.className = `fas fa-check tick-icon ${message.seen ? 'seen fa-check-double' : 'fa-check'}`;
                footerDiv.appendChild(tickIcon);
            }

            contentWrapper.appendChild(footerDiv);
            messageDiv.appendChild(contentWrapper);

            chatMessages.appendChild(messageDiv);
        }

        function updateMessageSeenStatus(messageKey) {
            const messageDiv = document.querySelector(`.message[data-message-key="${messageKey}"] .tick-icon`);
            if (messageDiv) {
                messageDiv.classList.add('fa-check-double');
                messageDiv.classList.add('seen');
                messageDiv.classList.remove('fa-check');
            }
        }

        function formatTimestamp(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function setTypingStatus(isTyping) {
            if (currentUser && targetUserId) {
                const typingStatusRef = database.ref(`typing-status/${currentUser.uid}/${targetUserId}`);
                typingStatusRef.set(isTyping);
            }
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText) {
                const newMessage = {
                    senderId: currentUser.uid,
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    seen: false
                };

                const newMessageRef = chatRef.child('messages').push();
                newMessageRef.set(newMessage);

                const lastMessageData = {
                    lastMessage: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref(`user-chats/${currentUser.uid}/${targetUserId}`).update(lastMessageData);
                database.ref(`user-chats/${targetUserId}/${currentUser.uid}`).update(lastMessageData);

                messageInput.value = '';
                messageInput.style.height = '40px';
                setTypingStatus(false);
            }
        }

        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = `${messageInput.scrollHeight}px`;

            setTypingStatus(true);

            clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                setTypingStatus(false);
            }, 2000);
        });

        backIcon.addEventListener('click', () => {
            window.location.href = 'home.html';
        });

        window.addEventListener('beforeunload', () => {
            if (currentUser && targetUserId) {
                const typingStatusRef = database.ref(`typing-status/${currentUser.uid}/${targetUserId}`);
                typingStatusRef.set(false);
            }
        });
    </script>
</body>
</html>
